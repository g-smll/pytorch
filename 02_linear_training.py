import torch
import torch.nn as nn
import torch.optim as optim
import matplotlib.pyplot as plt
import numpy as np

print("=== å’–å•¡åº—æ™ºèƒ½å®šä»·ç³»ç»Ÿ - å‡çº§ç‰ˆï¼šè®©AIçœŸæ­£å­¦ä¼šå®šä»· ===\n")

# ============================================================================
# ç¬¬ä¸€éƒ¨åˆ†ï¼šæ•°æ®å‡†å¤‡ - æ¨¡æ‹Ÿå†å²é”€å”®æ•°æ®
# ============================================================================

print("ğŸ“Š ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡å†å²é”€å”®æ•°æ®")
print("æ¨¡æ‹Ÿå’–å•¡åº—è¿‡å»3ä¸ªæœˆçš„é”€å”®è®°å½•ï¼Œè®©AIä»ä¸­å­¦ä¹ æœ€ä¼˜å®šä»·ç­–ç•¥\n")

# æ¨¡æ‹Ÿå†å²æ•°æ®ï¼š[æˆæœ¬, ç¹å¿™åº¦, å¤©æ°”, ç«å“ä»·] -> å®é™…æœ€ä¼˜å”®ä»·
historical_data = [
    # æˆåŠŸæ¡ˆä¾‹ - é”€é‡å¥½çš„å®šä»·
    ([8.0, 3.0, 6.0, 25.0], 21.0),  # å‘¨ä¸€æ—©æ™¨ï¼Œå®šä»·21å…ƒï¼Œé”€é‡å¥½
    ([8.0, 8.0, 9.0, 25.0], 24.0),  # å‘¨äº”ä¸‹åˆï¼Œå®šä»·24å…ƒï¼Œé”€é‡å¥½
    ([8.0, 2.0, 2.0, 25.0], 19.5),  # é›¨å¤©ä¸Šåˆï¼Œå®šä»·19.5å…ƒï¼Œé”€é‡å¥½
    ([10.0, 10.0, 10.0, 30.0], 28.0), # èŠ‚å‡æ—¥ï¼Œå®šä»·28å…ƒï¼Œé”€é‡å¥½
    
    # æ›´å¤šè®­ç»ƒæ•°æ®
    ([7.0, 5.0, 7.0, 24.0], 20.5),
    ([9.0, 6.0, 8.0, 26.0], 23.5),
    ([8.5, 4.0, 5.0, 25.5], 21.8),
    ([7.5, 9.0, 9.5, 27.0], 24.8),
    ([9.5, 7.0, 6.0, 28.0], 25.2),
    ([8.0, 1.0, 3.0, 23.0], 18.5),
]

# è½¬æ¢ä¸ºPyTorchå¼ é‡
X_train = torch.tensor([data[0] for data in historical_data], dtype=torch.float32)
y_train = torch.tensor([data[1] for data in historical_data], dtype=torch.float32).reshape(-1, 1)

print(f"è®­ç»ƒæ•°æ®è§„æ¨¡ï¼š{len(historical_data)}æ¡å†å²è®°å½•")
print(f"è¾“å…¥ç‰¹å¾ï¼š{X_train.shape}")
print(f"ç›®æ ‡ä»·æ ¼ï¼š{y_train.shape}\n")

# ============================================================================
# ç¬¬äºŒéƒ¨åˆ†ï¼šæ¨¡å‹å®šä¹‰ - å¯å­¦ä¹ çš„å®šä»·æ¨¡å‹
# ============================================================================

print("ğŸ§  ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå¯å­¦ä¹ çš„AIå®šä»·æ¨¡å‹")

class CoffeePricingModel(nn.Module):
    def __init__(self):
        super(CoffeePricingModel, self).__init__()
        self.linear = nn.Linear(4, 1)  # 4ä¸ªè¾“å…¥ -> 1ä¸ªä»·æ ¼è¾“å‡º
        
    def forward(self, x):
        return self.linear(x)

# åˆ›å»ºæ¨¡å‹å®ä¾‹
model = CoffeePricingModel()

print("æ¨¡å‹ç»“æ„ï¼š")
print(model)
print(f"\nåˆå§‹æƒé‡ï¼š{model.linear.weight.data}")
print(f"åˆå§‹åç½®ï¼š{model.linear.bias.data}\n")

# ============================================================================
# ç¬¬ä¸‰éƒ¨åˆ†ï¼šæŸå¤±å‡½æ•°ä¸ä¼˜åŒ–å™¨ - å­¦ä¹ çš„æ ¸å¿ƒ
# ============================================================================

print("âš™ï¸ ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®å­¦ä¹ æœºåˆ¶")

# æŸå¤±å‡½æ•°ï¼šè¡¡é‡é¢„æµ‹ä»·æ ¼ä¸å®é™…æœ€ä¼˜ä»·æ ¼çš„å·®è·
criterion = nn.MSELoss()  # å‡æ–¹è¯¯å·®æŸå¤±

# ä¼˜åŒ–å™¨ï¼šè´Ÿè´£æ›´æ–°æ¨¡å‹å‚æ•°
optimizer = optim.SGD(model.parameters(), lr=0.01)  # éšæœºæ¢¯åº¦ä¸‹é™

print("æŸå¤±å‡½æ•°ï¼šå‡æ–¹è¯¯å·® (MSE)")
print("ä¼˜åŒ–å™¨ï¼šéšæœºæ¢¯åº¦ä¸‹é™ (SGD)")
print("å­¦ä¹ ç‡ï¼š0.01\n")

# ============================================================================
# ç¬¬å››éƒ¨åˆ†ï¼šè®­ç»ƒè¿‡ç¨‹ - AIå­¦ä¹ å®šä»·ç­–ç•¥
# ============================================================================

print("ğŸ“ ç¬¬å››æ­¥ï¼šå¼€å§‹è®­ç»ƒ - è®©AIå­¦ä¼šå®šä»·")

# è®°å½•è®­ç»ƒè¿‡ç¨‹
losses = []
epochs = 1000

print("è®­ç»ƒè¿›åº¦ï¼š")
for epoch in range(epochs):
    # å‰å‘ä¼ æ’­ï¼šé¢„æµ‹ä»·æ ¼
    predicted_prices = model(X_train)
    
    # è®¡ç®—æŸå¤±ï¼šé¢„æµ‹ä»·æ ¼ vs å®é™…æœ€ä¼˜ä»·æ ¼
    loss = criterion(predicted_prices, y_train)
    
    # åå‘ä¼ æ’­ï¼šè®¡ç®—æ¢¯åº¦
    optimizer.zero_grad()  # æ¸…é›¶ä¸Šä¸€æ¬¡çš„æ¢¯åº¦
    loss.backward()        # è®¡ç®—å½“å‰æ¢¯åº¦
    
    # å‚æ•°æ›´æ–°ï¼šæ ¹æ®æ¢¯åº¦è°ƒæ•´æƒé‡
    optimizer.step()
    
    # è®°å½•æŸå¤±
    losses.append(loss.item())
    
    # æ˜¾ç¤ºè®­ç»ƒè¿›åº¦
    if (epoch + 1) % 200 == 0:
        print(f"Epoch {epoch+1:4d}/1000, Loss: {loss.item():.4f}")

print(f"\nè®­ç»ƒå®Œæˆï¼æœ€ç»ˆæŸå¤±ï¼š{losses[-1]:.4f}")

# ============================================================================
# ç¬¬äº”éƒ¨åˆ†ï¼šå­¦ä¹ æ•ˆæœåˆ†æ
# ============================================================================

print("\nğŸ“ˆ ç¬¬äº”æ­¥ï¼šåˆ†æAIçš„å­¦ä¹ æ•ˆæœ")

print("å­¦ä¹ å‰åçš„å‚æ•°å¯¹æ¯”ï¼š")
print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
print("â”‚     å‚æ•°ç±»å‹     â”‚     å­¦ä¹ å‰       â”‚     å­¦ä¹ å       â”‚")
print("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")

# æ˜¾ç¤ºå­¦ä¹ åçš„å‚æ•°
learned_weights = model.linear.weight.data[0]
learned_bias = model.linear.bias.data[0]

print(f"â”‚ æˆæœ¬ç³»æ•° (w1)    â”‚      éšæœº        â”‚    {learned_weights[0]:.3f}      â”‚")
print(f"â”‚ ç¹å¿™ç³»æ•° (w2)    â”‚      éšæœº        â”‚    {learned_weights[1]:.3f}      â”‚")
print(f"â”‚ å¤©æ°”ç³»æ•° (w3)    â”‚      éšæœº        â”‚    {learned_weights[2]:.3f}      â”‚")
print(f"â”‚ ç«å“ç³»æ•° (w4)    â”‚      éšæœº        â”‚    {learned_weights[3]:.3f}      â”‚")
print(f"â”‚ åŸºç¡€åˆ©æ¶¦ (b)     â”‚      éšæœº        â”‚    {learned_bias:.3f}      â”‚")
print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n")

# ============================================================================
# ç¬¬å…­éƒ¨åˆ†ï¼šæ¨¡å‹éªŒè¯ - æµ‹è¯•AIçš„å®šä»·èƒ½åŠ›
# ============================================================================

print("ğŸ§ª ç¬¬å…­æ­¥ï¼šæµ‹è¯•AIå­¦åˆ°çš„å®šä»·ç­–ç•¥")

# æµ‹è¯•æ–°åœºæ™¯
test_scenarios = [
    {
        "name": "æ–°åœºæ™¯1ï¼šå‘¨ä¸‰ä¸­åˆ",
        "factors": [8.5, 6.0, 7.5, 26.0],
        "description": "æˆæœ¬8.5å…ƒï¼Œä¸­ç­‰ç¹å¿™(6åˆ†)ï¼Œå¤©æ°”ä¸é”™(7.5åˆ†)ï¼Œç«å“26å…ƒ"
    },
    {
        "name": "æ–°åœºæ™¯2ï¼šæš´é›¨å¤©",
        "factors": [8.0, 1.0, 1.0, 24.0],
        "description": "æˆæœ¬8å…ƒï¼Œå¾ˆé—²(1åˆ†)ï¼Œæš´é›¨(1åˆ†)ï¼Œç«å“24å…ƒ"
    },
    {
        "name": "æ–°åœºæ™¯3ï¼šå‘¨æœ«æ™šä¸Š",
        "factors": [9.0, 9.0, 8.0, 28.0],
        "description": "æˆæœ¬9å…ƒï¼Œè¶…å¿™(9åˆ†)ï¼Œå¤©æ°”å¥½(8åˆ†)ï¼Œç«å“28å…ƒ"
    }
]

print("AIå®šä»·æµ‹è¯•ç»“æœï¼š")
model.eval()  # åˆ‡æ¢åˆ°è¯„ä¼°æ¨¡å¼
with torch.no_grad():  # ä¸éœ€è¦è®¡ç®—æ¢¯åº¦
    for scenario in test_scenarios:
        # è¾“å…¥æ–°åœºæ™¯æ•°æ®
        test_input = torch.tensor([scenario["factors"]], dtype=torch.float32)
        
        # AIé¢„æµ‹ä»·æ ¼
        ai_price = model(test_input).item()
        
        # è®¡ç®—é¢„æœŸåˆ©æ¶¦
        cost = scenario["factors"][0]
        profit = ai_price - cost
        
        print(f"\nğŸ“… {scenario['name']}ï¼š")
        print(f"   {scenario['description']}")
        print(f"   ğŸ¤– AIå»ºè®®å”®ä»·ï¼š{ai_price:.2f}å…ƒ")
        print(f"   ğŸ’° é¢„æœŸåˆ©æ¶¦ï¼š{profit:.2f}å…ƒ")
        
        # ä¸šåŠ¡åˆç†æ€§åˆ¤æ–­
        if profit < 2:
            print("   âš ï¸  åˆ©æ¶¦åä½ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´")
        elif profit > 10:
            print("   ğŸ“ˆ åˆ©æ¶¦å¾ˆé«˜ï¼Œæ³¨æ„å¸‚åœºæ¥å—åº¦")
        else:
            print("   âœ… åˆ©æ¶¦åˆç†ï¼Œå®šä»·ç­–ç•¥è‰¯å¥½")

# ============================================================================
# ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå­¦ä¹ è¿‡ç¨‹å¯è§†åŒ–
# ============================================================================

print(f"\nğŸ“Š ç¬¬ä¸ƒæ­¥ï¼šå¯è§†åŒ–AIçš„å­¦ä¹ è¿‡ç¨‹")

# åˆ›å»ºæŸå¤±æ›²çº¿å›¾
plt.figure(figsize=(12, 4))

# å­å›¾1ï¼šæŸå¤±ä¸‹é™æ›²çº¿
plt.subplot(1, 2, 1)
plt.plot(losses)
plt.title('AIå­¦ä¹ è¿‡ç¨‹ï¼šæŸå¤±å‡½æ•°ä¸‹é™æ›²çº¿')
plt.xlabel('è®­ç»ƒè½®æ¬¡ (Epoch)')
plt.ylabel('æŸå¤±å€¼ (Loss)')
plt.grid(True)

# å­å›¾2ï¼šé¢„æµ‹ vs å®é™…å¯¹æ¯”
plt.subplot(1, 2, 2)
model.eval()
with torch.no_grad():
    predictions = model(X_train).numpy()
    actual = y_train.numpy()

plt.scatter(actual, predictions, alpha=0.7)
plt.plot([actual.min(), actual.max()], [actual.min(), actual.max()], 'r--', lw=2)
plt.xlabel('å®é™…æœ€ä¼˜ä»·æ ¼')
plt.ylabel('AIé¢„æµ‹ä»·æ ¼')
plt.title('é¢„æµ‹å‡†ç¡®æ€§ï¼šAIé¢„æµ‹ vs å®é™…ä»·æ ¼')
plt.grid(True)

plt.tight_layout()
plt.savefig('coffee_pricing_ai_training.png', dpi=300, bbox_inches='tight')
print("å­¦ä¹ è¿‡ç¨‹å›¾è¡¨å·²ä¿å­˜ä¸ºï¼šcoffee_pricing_ai_training.png")

# ============================================================================
# ç¬¬å…«éƒ¨åˆ†ï¼šä¸šåŠ¡æ´å¯Ÿä¸æ€»ç»“
# ============================================================================

print(f"\nğŸ’¡ ç¬¬å…«æ­¥ï¼šAIå­¦ä¹ åˆ°çš„ä¸šåŠ¡æ´å¯Ÿ")

print("ğŸ” AIå‘ç°çš„å®šä»·è§„å¾‹ï¼š")
w = model.linear.weight.data[0]
b = model.linear.bias.data[0]

print(f"â€¢ æˆæœ¬å½±å“ç³»æ•°ï¼š{w[0]:.3f} - æˆæœ¬æ¯å¢åŠ 1å…ƒï¼Œå”®ä»·å¢åŠ {w[0]:.3f}å…ƒ")
print(f"â€¢ ç¹å¿™å½±å“ç³»æ•°ï¼š{w[1]:.3f} - ç¹å¿™åº¦æ¯å¢åŠ 1åˆ†ï¼Œå”®ä»·å¢åŠ {w[1]:.3f}å…ƒ")
print(f"â€¢ å¤©æ°”å½±å“ç³»æ•°ï¼š{w[2]:.3f} - å¤©æ°”æ¯æ”¹å–„1åˆ†ï¼Œå”®ä»·å¢åŠ {w[2]:.3f}å…ƒ")
print(f"â€¢ ç«å“å½±å“ç³»æ•°ï¼š{w[3]:.3f} - ç«å“ä»·æ¯å¢åŠ 1å…ƒï¼Œå”®ä»·å¢åŠ {w[3]:.3f}å…ƒ")
print(f"â€¢ åŸºç¡€å®šä»·ï¼š{b:.3f}å…ƒ - ä¸è€ƒè™‘å…¶ä»–å› ç´ çš„åŸºç¡€ä»·æ ¼")

print(f"\nğŸ¯ å…³é”®å­¦ä¹ æˆæœï¼š")
print("âœ… AIæˆåŠŸå­¦ä¼šäº†ä»å†å²æ•°æ®ä¸­æå–å®šä»·è§„å¾‹")
print("âœ… æ¨¡å‹èƒ½å¤Ÿè‡ªåŠ¨è°ƒæ•´å‚æ•°ä»¥é€‚åº”å®é™…ä¸šåŠ¡æƒ…å†µ")
print("âœ… é€šè¿‡è®­ç»ƒï¼ŒAIçš„å®šä»·é¢„æµ‹è¶Šæ¥è¶Šå‡†ç¡®")
print("âœ… å­¦åˆ°çš„æƒé‡åæ˜ äº†çœŸå®çš„ä¸šåŠ¡é‡è¦æ€§")

print(f"\nğŸš€ å‡çº§çŸ¥è¯†ç‚¹æ€»ç»“ï¼š")
print("1ï¸âƒ£ æŸå¤±å‡½æ•° (MSE)ï¼šè¡¡é‡é¢„æµ‹ä¸å®é™…çš„å·®è·")
print("2ï¸âƒ£ ä¼˜åŒ–å™¨ (SGD)ï¼šè‡ªåŠ¨è°ƒæ•´æ¨¡å‹å‚æ•°")
print("3ï¸âƒ£ è®­ç»ƒå¾ªç¯ï¼šå‰å‘ä¼ æ’­ â†’ è®¡ç®—æŸå¤± â†’ åå‘ä¼ æ’­ â†’ æ›´æ–°å‚æ•°")
print("4ï¸âƒ£ æ•°æ®é›†å¤„ç†ï¼šä½¿ç”¨çœŸå®å†å²æ•°æ®è®­ç»ƒæ¨¡å‹")
print("5ï¸âƒ£ æ¨¡å‹è¯„ä¼°ï¼šæµ‹è¯•AIåœ¨æ–°åœºæ™¯ä¸‹çš„è¡¨ç°")
print("6ï¸âƒ£ å¯è§†åŒ–åˆ†æï¼šè§‚å¯Ÿå­¦ä¹ è¿‡ç¨‹å’Œæ•ˆæœ")

print(f"\nğŸ”„ ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®ï¼š")
print("â€¢ å°è¯•ä¸åŒçš„ä¼˜åŒ–å™¨ (Adam, RMSprop)")
print("â€¢ å®éªŒä¸åŒçš„å­¦ä¹ ç‡")
print("â€¢ æ·»åŠ æ­£åˆ™åŒ–é˜²æ­¢è¿‡æ‹Ÿåˆ")
print("â€¢ ä½¿ç”¨éªŒè¯é›†è¯„ä¼°æ³›åŒ–èƒ½åŠ›")
print("â€¢ å°è¯•å¤šå±‚ç¥ç»ç½‘ç»œå¤„ç†å¤æ‚å…³ç³»")

if __name__ == "__main__":
    print("\n" + "="*60)
    print("ğŸ‰ æ­å–œï¼ä½ å·²ç»æŒæ¡äº†æœºå™¨å­¦ä¹ çš„æ ¸å¿ƒæ¦‚å¿µï¼š")
    print("ä»é™æ€çš„Linearå±‚ â†’ å¯å­¦ä¹ çš„AIæ¨¡å‹")
    print("è¿™æ˜¯æ·±åº¦å­¦ä¹ çš„é‡è¦é‡Œç¨‹ç¢‘ï¼")
    print("="*60)